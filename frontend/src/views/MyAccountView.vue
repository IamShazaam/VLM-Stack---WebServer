<template>
  <main class="main">
    <aside>
      <div class="rankings blockHome">
        <div class="h2-title h2-title-table flex-s-c">
          <span>Rankings</span>
          <div class="tabTable">
            <a class="tabTable-button active" data-tab="players">Players</a>
          </div>
        </div>
        <!--h2-title-->
        <div class="table tabTable-block active" id="players">
          <div class="tableBlock">
            <div class="tableBlock-title">
              <div class="tableBlock-title_player">Player</div>
              <div class="tableBlock-title_level">Level</div>
              <div class="tableBlock-title_score">Score</div>
            </div>

            <div class="tableBlock-content">
              <div class="tableBlock-conten_number">10</div>
              <div class="tableBlock-conten_name">
                <img src="../assets/rank-icon_5.png" alt="" /><a href=""
                  >Zunderstrom
                  <div class="tablePopup">
                    <span class="tablePopup-title">Nickname</span>
                    <div class="tablePopup-ava">
                      <img src="../assets/ava-popup.png" alt="" />
                    </div>
                    <div class="tablePopup-block">
                      <span>Icon Class:</span> <span>Class</span>
                    </div>
                    <div class="tablePopup-block">
                      <span>Rank System:</span> <span>System</span>
                    </div>
                    <div class="tablePopup-block">
                      <span>Level:</span> <span>150</span>
                    </div>
                    <div class="tablePopup-block">
                      <span>Class:</span> <span>Class</span>
                    </div>
                    <div class="tablePopup-block">
                      <span>Play Time:</span> <span>18.02.2021</span>
                    </div>
                    <div class="tablePopup-block">
                      <span>Sex:</span> <span>Man</span>
                    </div>
                  </div>
                </a>
              </div>
              <div class="tableBlock-conten_lvl">
                <span class="color-yellow">15</span>
              </div>
              <div class="tableBlock-conten_scr">2 373</div>
            </div>
          </div>
          <div class="all-button">
            <a href="" class="button">View All</a>
          </div>
        </div>
        <div class="table tabTable-block" id="legions">
          <div class="tableBlock">
            <div class="tableBlock-title">
              <div class="tableBlock-title_player">Legions</div>
              <div class="tableBlock-title_level">Level</div>
              <div class="tableBlock-title_score">Score</div>
            </div>
            <div class="tableBlock-content">
              <div class="tableBlock-conten_number">1</div>
              <div class="tableBlock-conten_name">
                <img src="../assets/rank-icon_1.png" alt="" />
                <a href="">Maverick1</a>
              </div>
              <div class="tableBlock-conten_lvl">
                <span class="color-purple">80</span>
              </div>
              <div class="tableBlock-conten_scr">16 373</div>
            </div>
            <div class="tableBlock-content">
              <div class="tableBlock-conten_number">2</div>
              <div class="tableBlock-conten_name">
                <img src="../assets/rank-icon_2.png" alt="" /><a href=""
                  >Very-Long_Nick-Name</a
                >
              </div>
              <div class="tableBlock-conten_lvl">
                <span class="color-purple">79</span>
              </div>
              <div class="tableBlock-conten_scr">15 373</div>
            </div>
            <div class="tableBlock-content">
              <div class="tableBlock-conten_number">3</div>
              <div class="tableBlock-conten_name">
                <img src="../assets/rank-icon_3.png" alt="" /><a href=""
                  >Graber1</a
                >
              </div>
              <div class="tableBlock-conten_lvl">
                <span class="color-purple">74</span>
              </div>
              <div class="tableBlock-conten_scr">14 373</div>
            </div>
            <div class="tableBlock-content">
              <div class="tableBlock-conten_number">4</div>
              <div class="tableBlock-conten_name">
                <img src="../assets/rank-icon_4.png" alt="" /><a href=""
                  >Andy1</a
                >
              </div>
              <div class="tableBlock-conten_lvl">
                <span class="color-blue">67</span>
              </div>
              <div class="tableBlock-conten_scr">14 373</div>
            </div>
            <div class="tableBlock-content">
              <div class="tableBlock-conten_number">5</div>
              <div class="tableBlock-conten_name">
                <img src="../assets/rank-icon_5.png" alt="" /><a href=""
                  >Richard1</a
                >
              </div>
              <div class="tableBlock-conten_lvl">
                <span class="color-blue">64</span>
              </div>
              <div class="tableBlock-conten_scr">13 373</div>
            </div>
            <div class="tableBlock-content">
              <div class="tableBlock-conten_number">6</div>
              <div class="tableBlock-conten_name">
                <img src="../assets/rank-icon_1.png" alt="" /><a href=""
                  >Pro-extreme1</a
                >
              </div>
              <div class="tableBlock-conten_lvl">
                <span class="color-blue">60</span>
              </div>
              <div class="tableBlock-conten_scr">11 373</div>
            </div>
            <div class="tableBlock-content">
              <div class="tableBlock-conten_number">7</div>
              <div class="tableBlock-conten_name">
                <img src="../assets/rank-icon_2.png" alt="" /><a href=""
                  >Fighter1</a
                >
              </div>
              <div class="tableBlock-conten_lvl">
                <span class="color-green">58</span>
              </div>
              <div class="tableBlock-conten_scr">9 373</div>
            </div>
            <div class="tableBlock-content">
              <div class="tableBlock-conten_number">8</div>
              <div class="tableBlock-conten_name">
                <img src="../assets/rank-icon_3.png" alt="" /><a href=""
                  >Gladiator1</a
                >
              </div>
              <div class="tableBlock-conten_lvl">
                <span class="color-green">55</span>
              </div>
              <div class="tableBlock-conten_scr">8 373</div>
            </div>
          </div>
          <div class="all-button">
            <a href="" class="button">View All</a>
          </div>
        </div>
      </div>
      <!--rankings-->
      <div class="forumHome blockHome">
        <div class="h2-title h2-title-content flex-s-c">
          <span>Forum Feed</span>
        </div>
        <!--h2-title-->
        <!--forumBlock-content-->
      </div>
      <!--forumHome-->
    </aside>

    <div class="content" v-if="loggedIn">
      <!-- content for logged in user -->
      <div class="h2-title h2-title-content flex-s-c">
        <span>Account Setting</span>
      </div>
      <div class="acc">
        <div class="acc-title">Account details</div>
        <div class="accBlock flex-s">
          <div class="accBlock-content">
            <div class="formGroup">
              <span>Login</span>
              <div class="fieldGroup-input">{{ username }}</div>
            </div>
            <div class="formGroup">
              <span>Date of Registration</span>
              <div class="fieldGroup-input">15.01.2021</div>
            </div>
          </div>
          <div class="accBlock-content">
            <div class="formGroup">
              <span>E-mail</span>
              <div class="fieldGroup-input">{{ email }}</div>
            </div>
            <div class="formGroup">
              <span>Last Login to the Game</span>
              <div class="fieldGroup-input">15.02.2021</div>
            </div>
          </div>
        </div>
        <!--accBlock-->
      </div>
      <!--acc-->
      <div class="acc">
        <div class="acc-title">Actions</div>
        <div class="accBlock flex-s">
          <div class="accBlock-content">
            <div class="formGroup">
              <span>Change account password</span
              ><input type="text" value="dkarts0000123456" />
            </div>
            <div class="formGroup">
              <span>Change character deletion code</span
              ><input type="text" value="dkarts0000123456" />
            </div>
          </div>
          <div class="accBlock-content">
            <div class="formGroup">
              <span>Change e-mail address</span
              ><input type="text" value="96452427" />
            </div>
            <div class="formGroup">
              <span>Change store code</span><input type="text" value="12548" />
            </div>
          </div>
        </div>
        <!--accBlock-->
        <div class="change-button">
          <button class="big-button-blue">Confirm Changes</button>
        </div>
      </div>
      <!--acc-->
      <div class="support">
        <div class="acc-title">Actions</div>
        <div class="supportButtons flex-c-c">
          <div class="supportButton">
            <button>Add a Ticket</button>
          </div>
          <div class="supportButton">
            <button>Check Ticket</button>
          </div>
        </div>
      </div>
      <!--support-->
    </div>

    <div class="content" v-else>
      <div class="h2-title h2-title-content flex-s-c">
        <span>Please, log in.</span>
      </div>
    </div>
  </main>
</template>

<script>
import axios from 'axios';
import jwt_decode from 'jwt-decode';
import bcrypt from 'bcryptjs';

export default {
  name: 'MyAccountView',
  data() {
    return {
      username: '',
      password: '',
      remember: false,
      loggedIn: false,
      user: null,
    };
  },
  methods: {
    login() {
      const hashedPassword = bcrypt.hashSync(this.password, 10);
      axios
        .post('/login', {
          username: this.username,
          password: hashedPassword,
          remember: this.remember,
        })
        .then((response) => {
          console.log(response);
          // Login successful, store JWT in local storage
          const decodedJwt = jwt_decode(response.data.jwt);
          console.log(decodedJwt);
          this.loggedIn = true;
          this.user = decodedJwt.username;
          console.log(this.user);
          localStorage.setItem('jwt', response.data.jwt);
          this.$router.push('/myaccount');
          console.log(this.username, 'is logged in from the endpoint');
        })
        .catch((error) => {
          console.error('Login error:', error);
        });
      console.log(this.username);
    },
    logout() {
      axios.post('/logout').then(() => {
        this.loggedIn = false;
        this.user = {};
        localStorage.removeItem('jwt');
        this.$router.push('/');
      });
    },
  },
  created() {
    const jwt = localStorage.getItem('jwt');
    if (jwt) {
      try {
        const decodedJwt = jwt_decode(jwt);
        console.log(decodedJwt);
        this.user = decodedJwt.username;
        this.loggedIn = decodedJwt.authenticated;
        console.log(this.user + ' is ' + this.loggedIn);
        axios
          .get('/user', {
            headers: {
              Authorization: decodedJwt.session_token,
            },
          })
          .then((response) => {
            //Taking the username from the db
            this.username = response.data.username;
            this.email = response.data.email;
            console.log(this.user);
          });
      } catch (error) {
        console.error('Error decoding JWT:', error);
      }
    }
  },
  mounted() {
    axios.get('/check-auth').then((response) => {
      this.authenticated = response.data.authenticated;
    });
  },
};
</script>
